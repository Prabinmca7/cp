<project name="CPAnalysis" default="echo" basedir=".">
	<description>Targets to run cp analysis</description>
	
	<!-- Properties -->
	<property name="CodeSnifferReport" value="${WORKSPACE}/codeSniffer.html"/>
	<property name="CPLintFile" value="${WORKSPACE}/cpLintOutput.txt"/>
	
	<target name="RunCPAnalysisDepends" depends="CleanCPAnalysis, ExecCodeSniffer, ExecCPLint" description="Runs the complete cp analysis test">
		<!-- count the lines in the output to determine number of failures -->
		<resourcecount property="report_lines">
			<tokens>
				<concat>
					<filterchain>
						<tokenfilter>
							<linetokenizer/>
						</tokenfilter>
					</filterchain>
					<fileset file="${CPLintFile}"/>
				</concat>
			</tokens>
		</resourcecount>

		<echo message="Fail if line count is greater than zero:${report_lines} or codesniffer throws exit code:${CodeSnifferExitCode}"/>

		<parallel threadCount="1">
			<fail message="CP Lint has failed with failure count: ${report_lines}">
				<condition><not><equals arg1="${report_lines}" arg2="0"/></not></condition>
			</fail>
			<fail message="CodeSniffer has failed with failure count: ${CodeSnifferExitCode}">
				<condition><not><equals arg1="${CodeSnifferExitCode}" arg2="0"/></not></condition>
			</fail>
		</parallel>
	</target>
	
	<target name="CleanCPAnalysis" description="exec cp lint for v2 ">
		<delete file="${CPLintFile}" failonerror="false" />
		<delete file="${CodeSnifferReport}" failonerror="false" />
	</target>
	
	<target name="ExecCodeSniffer" description="build cp with rake">
		<exec executable="/bin/sh" failonerror="false" resultproperty="CodeSnifferExitCode" >
			<arg value="-c" />			     
			<arg value="python ${WORKSPACE}/scripts/cp/extras/testRunner/staticAnalysis.py --type=codeSniffer --htmlArtifact=${CodeSnifferReport}"/>
		</exec>		
	</target>	
	
	<target name="ExecCPLint" description="build cp with rake">
		<exec executable="/bin/sh" failonerror="false" >
			<arg value="-c" />			     			
			<arg value="cd ${WORKSPACE}; find scripts/cp -name \*.php ! -path &apos;*generated*&apos; -name \*.php ! -name optimized_includes.php ! -name CodeWriter.test.php ! -name Tags.php ! -name *.test_disabled.php -exec /nfs/local/linux/php/php-5.6.40-1911/bin/php-5.6.40-1911 -c server/src/test/rnw/scripts/euf/PHP_Lint/lint.php.ini -l {} \; 2&gt;&amp;1 &gt; /dev/null | grep -v -P &apos;Call-time pass-by-reference has been deprecated.*core/framework/Libraries/Hooks.php&apos; &gt;&gt; ${CPLintFile} 2&gt;&amp;1"/>
		</exec>
	</target>
		
</project>
