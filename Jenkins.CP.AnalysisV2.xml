<project name="CPAnalysisV2" default="" basedir=".">
	<description>Targets to run cp analysis</description>
	
	<!-- Properties -->
	<property name="CodeSnifferReportV2" value="${WORKSPACE}/codeSnifferV2.xml"/>
	<property name="CPLintFileV2" value="${WORKSPACE}/cpLintOutputV2.txt"/>
		
	<target name="RunCPAnalysisDependsV2" depends="CleanCPAnalysisV2, ExecCodeSnifferV2, ExecCPLintV2" description="Runs the complete cp analysis test">
		<!-- count the lines in the output to determine number of failures -->
		<resourcecount property="report_lines">
			<tokens>
				<concat>
					<filterchain>
						<tokenfilter>
							<linetokenizer/>
						</tokenfilter>
					</filterchain>
					<fileset file="${CPLintFileV2}"/>
				</concat>
			</tokens>
		</resourcecount>

		<echo message="Fail if line count is greater than zero:${report_lines}"/>

		<parallel threadCount="1">
			<fail message="CP Lint has failed with failure count: ${report_lines}">
				<condition><not><equals arg1="${report_lines}" arg2="0"/></not></condition>
			</fail>
			<fail message="CodeSniffer has failed with failure count: ${CodeSnifferExitCode}">
				<condition><not><equals arg1="${CodeSnifferExitCode}" arg2="0"/></not></condition>
			</fail>
		</parallel>
	</target>

	<target name="CleanCPAnalysisV2" description="exec cp lint for v2 ">
		<delete file="${CPLintFileV2}" failonerror="false" />
		<delete file="${CodeSnifferReportV2}" failonerror="false" />
	</target>

	<target name="ExecCodeSnifferV2" description="exec code sniffer for v2">
		<exec executable="/nfs/local/linux/chroot/bin/chroot" failonerror="false" resultproperty="CodeSnifferExitCode" >
			<arg line="/nfs/local/linux/chroot/CentOS5/ ${WORKSPACE} bash -c '${WORKSPACE}/server/src/test/rnw/scripts/euf/PHP_CodeSniffer/1.2/scripts/phpcscp.sh ${WORKSPACE}/server/src/rnw/scripts/euf suppressions.php &gt;&gt; ${CodeSnifferReportV2} 2&gt;&amp;1'"/>
		</exec>		
	</target>
	
	<target name="ExecCPLintV2" description="exec cp lint for v2 ">
		<exec executable="/bin/sh" failonerror="false" >
			<arg value="-c" />			   
			<arg value="cd ${WORKSPACE}; find server/src/rnw/scripts/euf -name \*.php ! -path &apos;*optimized*&apos; -name \*.php ! -name optimized_includes.php -exec /nfs/local/linux/php/php-5.3.2-1011/bin/php-5.3.2-1011 -c server/src/test/rnw/scripts/euf/PHP_Lint/lint.php.ini -l {} \; 2&gt;&amp;1 &gt; /dev/null | grep -v -P &quot;Call-time pass-by-reference has been deprecated.*rightnow/classes/RightNowHooks.php&quot; &gt;&gt; ${CPLintFileV2} 2&gt;&amp;1"/>
		</exec>
	</target>
	
</project>